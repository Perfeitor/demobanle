@page "/Danhmuc/Vattuhanghoa/Khohang"
@using DBDATA.Models
@using MUDTEMPLATE.Services
@using DBDATA
@using Microsoft.AspNetCore.Authorization

@inject IKhohangService khohangService

@attribute [Authorize]

<style>
    .selected {
        background-color: #1E88E5 !important;
    }

        .selected > td {
            color: white !important;
        }

            .selected > td .mud-input {
                color: white !important;
            }
</style>

<MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6" Color="@Color.Primary">
    <MudTabPanel Text="Thông tin chung">
        <MudPaper Class="p-2 mb-2">
            <MudGrid Spacing="1">
                @if (createMode)
                {
                    <MudItem xs="6" md="4">
                        <MudTextField Margin="Margin.Dense" @bind-Value="@newItem.Makhohang" Label="Mã kho hàng"
                                      Variant="Variant.Outlined">
                        </MudTextField>
                    </MudItem>

                    <MudItem xs="12" md="4">
                        <MudTextField Margin="Margin.Dense" @bind-Value="@newItem.Tenkhohang" Label="Tên kho hàng"
                                      Variant="Variant.Outlined">
                        </MudTextField>
                    </MudItem>

                    <MudItem xs="6" md="4">
                        <MudSelect Label="Mã loại kho" Dense="true" ReadOnly="false" Variant="Variant.Outlined" Margin="Margin.Dense" Lines="1" T="string"
                                   @bind-Value="@lastClickItem.Maloaikho" @bind-Value:after=ChangedKhohang>
                            <Virtualize Items="@Khohangs" Context="khohang">
                                <MudSelectItem @bind-Value="khohang.Makhohang"></MudSelectItem>
                            </Virtualize>
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="6" md="4">
                        <MudTextField Margin="Margin.Dense" @bind-Value="@newItem.Dienthoai" Label="Điện thoại"
                                      Variant="Variant.Outlined">
                        </MudTextField>
                    </MudItem>

                    <MudItem xs="12" md="4">
                        <MudTextField Margin="Margin.Dense" @bind-Value="@newItem.Diachi" Label="Địa chỉ"
                                      Variant="Variant.Outlined">
                        </MudTextField>
                    </MudItem>

                    <MudItem xs="12" md="4">
                        <MudTextField Margin="Margin.Dense" @bind-Value="@newItem.Ghichu" Label="Ghi chú"
                                      Variant="Variant.Outlined">
                        </MudTextField>
                    </MudItem>

                    <MudItem xs="12" md="4">
                        <MudTextField Margin="Margin.Dense" @bind-Value="@newItem.Tenhienthihoadon" Label="Tên đơn vị"
                                      Variant="Variant.Outlined">
                        </MudTextField>
                    </MudItem>
                }

                @if (!createMode)
                {
                    <MudItem xs="6" md="4">
                        <MudTextField Margin="Margin.Dense" @bind-Value="@SelectedItem.Makhohang" Label="Mã kho hàng"
                                      Variant="Variant.Outlined" disabled="@isTextBoxDisabled">
                        </MudTextField>
                    </MudItem>

                    <MudItem xs="12" md="4">
                        <MudTextField Margin="Margin.Dense" @bind-Value="@SelectedItem.Tenkhohang" Label="Tên kho hàng"
                                      Variant="Variant.Outlined" disabled="@isTextBoxDisabled">
                        </MudTextField>
                    </MudItem>

                    <MudItem xs="6" md="4">
                        <MudTextField Margin="Margin.Dense" @bind-Value="@SelectedItem.Maloaikho" Label="Mã loại kho"
                                      Variant="Variant.Outlined" disabled="@isTextBoxDisabled">
                        </MudTextField>
                    </MudItem>

                    <MudItem xs="6" md="4">
                        <MudTextField Margin="Margin.Dense" @bind-Value="@SelectedItem.Dienthoai" Label="Điện thoại"
                                      Variant="Variant.Outlined" disabled="@isTextBoxDisabled">
                        </MudTextField>
                    </MudItem>

                    <MudItem xs="12" md="4">
                        <MudTextField Margin="Margin.Dense" @bind-Value="@SelectedItem.Diachi" Label="Địa chỉ"
                                      Variant="Variant.Outlined" disabled="@isTextBoxDisabled">
                        </MudTextField>
                    </MudItem>

                    <MudItem xs="12" md="4">
                        <MudTextField Margin="Margin.Dense" @bind-Value="@SelectedItem.Ghichu" Label="Ghi chú"
                                      Variant="Variant.Outlined" disabled="@isTextBoxDisabled">
                        </MudTextField>
                    </MudItem>

                    <MudItem xs="12" md="4">
                        <MudTextField Margin="Margin.Dense" @bind-Value="@SelectedItem.Tenhienthihoadon" Label="Tên đơn vị"
                                      Variant="Variant.Outlined" disabled="@isTextBoxDisabled">
                        </MudTextField>
                    </MudItem>
                }
                <MudItem xs="12" md="12" Class="px-2">
                    <MudButton xs="4" Size="Size.Small" Disabled="@btnStatus" Class="mr-1 mb-2" Variant="Variant.Filled" OnClick="Add"
                               StartIcon="@Icons.Material.Filled.Add" Color="Color.Success">Thêm</MudButton>

                    <MudButton xs="4" Size="Size.Small" Disabled="@btnStatus" Class="mr-1 mb-2" Variant="Variant.Filled" OnClick="Edit"
                               StartIcon="@Icons.Material.Filled.Edit" Color="Color.Warning">Sửa</MudButton>

                    <MudButton xs="4" Size="Size.Small" Disabled="@btnStatus" Class="mr-1 mb-2" Variant="Variant.Filled" OnClick="Delete"
                               StartIcon="@Icons.Material.Filled.Delete" Color="Color.Error">Xoá</MudButton>

                    <MudButton xs="6" Size="Size.Small" Disabled="@(!btnStatus)" Class="mr-1 mb-2" Variant="Variant.Filled" OnClick="Confirm"
                               StartIcon="@Icons.Material.Filled.Check" Color="Color.Success">Lưu</MudButton>

                    <MudButton xs="6" Size="Size.Small" Disabled="@(!btnStatus)" Class="mr-1 mb-2" Variant="Variant.Filled" OnClick="Cancel"
                               StartIcon="@Icons.Material.Filled.Cancel" Color="Color.Error">Hủy</MudButton>
                </MudItem>

                <MudItem xs="12" md="12">
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <MudAlert Severity="Severity.Warning">@errorMessage</MudAlert>
                    }
                    @if (!string.IsNullOrEmpty(successMessage))
                    {
                        <MudAlert Severity="Severity.Success">@successMessage</MudAlert>
                    }
                </MudItem>
            </MudGrid>
        </MudPaper>

        <MudPaper>
            <MudDataGrid Dense="true" Breakpoint="Breakpoint.None" Style="white-space:nowrap" Bordered="true" Striped="true" Items="@Khohangs"
                         RowClassFunc="HighlightSelectedItem" SortMode="SortMode.Multiple" MultiSelection="false" Hover="true"
                         @bind-SelectedItem=@SelectedItem>
                <ToolBarContent>
                    <MudItem xs="12" md="12" Class="px-2">
                        <MudTextField @bind-Value="_searchString" Placeholder="Search" Adornment="Adornment.Start" Immediate="true"
                                      AdornmentIcon="@Icons.Material.Filled.Search" Variant="Variant.Outlined" Margin="Margin.Dense"></MudTextField>
                    </MudItem>
                </ToolBarContent>

                <Columns>
                    <PropertyColumn Property="x => x.Makhohang" Title="Mã Kho hàng" />
                    <PropertyColumn Property="x => x.Tenkhohang" Title="Tên kho hàng" />
                    <PropertyColumn Property="x => x.Diachi" Title="Địa chỉ" />
                    <PropertyColumn Property="x => x.Dienthoai" Title="Điện thoại" />
                    <PropertyColumn Property="x => x.Ghichu" Title="Ghi chú" />
                    <PropertyColumn Property="x => x.Tendangnhap" Title="Người tạo" />
                    <PropertyColumn Property="x => x.Maloaikho" Title="Mã loại kho" />
                    <PropertyColumn Property="x => x.Makhoxuat" Title="Mã xuất kho" />
                    <PropertyColumn Property="x => x.MaptnxTienmat" Title="Phương thức tiền mặt" />
                    <PropertyColumn Property="x => x.MaptnxThe" Title="Phương thức tiền thẻ" />
                    <PropertyColumn Property="x => x.Tenhienthihoadon" Title="Tên hiển thị trên hóa đơn" />
                </Columns>
                <PagerContent>
                    <MudDataGridPager Style="max-width:100%" T="DBDATA.Models.Khohang" />
                </PagerContent>
            </MudDataGrid>
        </MudPaper>
    </MudTabPanel>

    <MudTabPanel Text="Thông tin khác">
        <MudText>Thông tin khác</MudText>
    </MudTabPanel>

    <MudTabPanel Text="Thông tin Tài khoản ngân hàng">
        <MudText>Thông tin Tài khoản ngân hàng</MudText>
    </MudTabPanel>

</MudTabs>

@code {
    #region Biến
    List<DBDATA.Models.Khohang> Khohangs = new();
    string selectedKhohang = "";
    bool btnStatus = false;
    bool createMode = false;
    bool editMode = false;
    string errorMessage = string.Empty;
    string successMessage = string.Empty;
    DBDATA.Models.Khohang newItem = new();
    DBDATA.Models.Khohang SelectedItem = new();
    public Khohang lastClickItem = new();
    private bool isTextBoxDisabled = true;
    private string _searchString;
    #endregion

    #region Khởi tạo
    protected override async Task OnInitializedAsync()
    {
        Khohangs = await khohangService.GetAllKhohang();
        // await Task.Run(LoadNhomhang);

        if (Khohangs.Count > 0)
            SelectedItem = Khohangs[0];
        return;
    }
    #endregion

    #region Phương thức
    public string HighlightSelectedItem(DBDATA.Models.Khohang SelectedKhohang, int RowNumber)
    {
        if (SelectedItem != null && SelectedItem.Equals(SelectedKhohang))
        {
            return "selected";
        }
        return string.Empty;
    }
    private void ChangedKhohang()
    {
        if (lastClickItem == null || Khohangs == null)
        {
            selectedKhohang = string.Empty;
        }

        var item = Khohangs.FirstOrDefault(n => n.Makhohang?.ToUpper() == lastClickItem.Makhohang?.ToUpper());
        selectedKhohang = item?.Tenkhohang ?? string.Empty;
    }
    public void Add()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;
        createMode = true;
        btnStatus = true;
    }
    public void Edit()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;
        editMode = true;
        btnStatus = true;
        isTextBoxDisabled = false;
    }
    public void Delete()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;
        btnStatus = true;
    }
    public async Task Confirm()
    {
        if (createMode)
        {
            if (!string.IsNullOrEmpty(newItem.Makhohang) && !string.IsNullOrEmpty(newItem.Tenkhohang))
            {
                await khohangService.AddKhohang(newItem);
                Khohangs = await khohangService.GetAllKhohang();
                successMessage = "Thêm kho hàng thành công";
            }
            else
            {
                errorMessage = "Xin vui lòng điền đầy đủ thông tin";
            }
        }
        else if (btnStatus)
        {
            if (editMode)
            {
                await khohangService.EditKhohang(SelectedItem);
                Khohangs = await khohangService.GetAllKhohang();
                successMessage = "Sửa nhóm hàng thành công";
            }
            else
            {
                await khohangService.DeleteKhohang(SelectedItem);
                Khohangs = await khohangService.GetAllKhohang();
                successMessage = "Xoá nhóm hàng thành công";
            }
        }
        SelectedItem = new();
        newItem = new();
        btnStatus = false;
        createMode = false;
        editMode = false;
        StateHasChanged();
    }
    public void Cancel()
    {
        SelectedItem = new();
        newItem = new();
        btnStatus = false;
        createMode = false;
        editMode = false;
        isTextBoxDisabled = true;
    }
    #endregion
}